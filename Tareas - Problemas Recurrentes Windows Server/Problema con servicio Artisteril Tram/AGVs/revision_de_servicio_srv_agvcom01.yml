---
- name: Verificar servicio Artisteril Tram y conexiones puerto 10000
  hosts: SRV-AGVTCM01
  gather_facts: no
  become: false

  tasks:

    ############################################################
    # 1ï¸âƒ£ Estado del servicio
    ############################################################
    - name: Obtener estado del servicio Artisteril Tram Service
      win_shell: |
        Get-Service -Name "Artisteril Tram Service" |
        Select-Object Status |
        ConvertTo-Json
      register: service_raw

    - name: Convertir estado del servicio a variable
      set_fact:
        service_status: "{{ (service_raw.stdout | from_json).Status }}"

    ############################################################
    # 2ï¸âƒ£ Verificar conexiones al puerto 10000
    ############################################################
    - name: Verificar conexiones activas al puerto 10000
      win_shell: |
        NETSTAT.EXE -ano | findstr :10000
      register: netstat_10000
      failed_when: false
      changed_when: false

    - name: Determinar si hay conexiones al puerto 10000
      set_fact:
        hay_conexiones_10000: "{{ netstat_10000.stdout | length > 0 }}"

    ############################################################
    # 3ï¸âƒ£ Mostrar resumen
    ############################################################
    - name: Mostrar resumen de validaciones
      debug:
        msg:
          - "Estado servicio: {{ service_status }}"
          - "Â¿Hay conexiones puerto 10000?: {{ hay_conexiones_10000 }}"

    ############################################################
    # 4ï¸âƒ£ Iniciar servicio SOLO si no hay conexiones
    ############################################################
    - name: Iniciar el servicio si estÃ¡ detenido y sin conexiones
      win_service:
        name: Artisteril Tram Service
        start_mode: auto
        state: started
      when:
        - service_status != 'Running'
        - not hay_conexiones_10000
      register: service_result

    ############################################################
    # 5ï¸âƒ£ Variables para el workflow (Telegram)
    ############################################################
    - name: Exportar variables para notificaciÃ³n
      set_fact:
        telegram_service_status: "{{ service_status }}"
        telegram_action: >-
          {% if hay_conexiones_10000 %}
          Servicio NO modificado (conexiones activas)
          {% elif service_status != 'Running' %}
          Servicio iniciado
          {% else %}
          Sin cambios
          {% endif %}
        telegram_port_connections: "{{ netstat_10000.stdout_lines | default([]) }}"

    ############################################################
    # 6ï¸âƒ£ Mensaje final (log del job)
    ############################################################
    - name: Mostrar resultado final
      debug:
        msg: >
          {% if hay_conexiones_10000 %}
          ğŸ”’ Servicio NO modificado porque hay conexiones activas al puerto 10000.
          {% elif service_status != 'Running' %}
          â–¶ï¸ Servicio Artisteril Tram estaba detenido y fue iniciado correctamente.
          {% else %}
          âœ… Servicio Artisteril Tram ya estaba en ejecuciÃ³n, no se hizo nada.
          {% endif %}
