---
- name: Enviar notificaciÃ³n Artisteril por Telegram
  hosts: localhost
  gather_facts: no

  tasks:

    - name: Normalizar variables recibidas de workflow
      set_fact:
        telegram_service_status: "{{ telegram_service_status | default('DESCONOCIDO') }}"
        telegram_action: "{{ telegram_action | default('N/A') }}"
        telegram_port_connections: "{{ telegram_port_connections | default([]) }}"
        telegram_reinicio: "{{ telegram_reinicio | default(false) }}"

    - name: Construir mensaje para ser enviado
      set_fact:
        telegram_message: |
          ğŸ–¥ï¸ Servidor: SRV-AGVTCM01
          ğŸ”§ Servicio: Artisteril Tram Service
          ğŸ“Œ Estado servicio: {{ telegram_service_status }}

          âš™ï¸ AcciÃ³n:
          {{ telegram_action }}

          ğŸš¨ğŸš¨ REINICIO DEL SERVIDOR EJECUTADO ğŸš¨ğŸš¨
          Motivo: No se detectaron conexiones activas en el puerto 10000

    - name: Enviar mensaje SOLO si hubo reinicio
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_id }}"
          text: "{{ telegram_message }}"
        status_code: 200
      when: telegram_reinicio | bool
