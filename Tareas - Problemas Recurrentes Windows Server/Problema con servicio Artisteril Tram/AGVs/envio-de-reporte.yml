---
- name: Enviar notificaci√≥n Artisteril por Telegram
  hosts: localhost
  gather_facts: no
  connection: local

  tasks:

    ############################################################
    # 1Ô∏è‚É£ Normalizar variables recibidas del workflow
    ############################################################
    - name: Normalizar variables
      set_fact:
        telegram_service_status: "{{ telegram_service_status | default('DESCONOCIDO') }}"
        telegram_action: "{{ telegram_action | default('N/A') }}"
        telegram_port_connections: "{{ telegram_port_connections | default([]) }}"

    ############################################################
    # 2Ô∏è‚É£ Construir mensaje Telegram
    ############################################################
    - name: Construir mensaje
      set_fact:
        telegram_message: |
          üñ•Ô∏è Servidor: SRV-AGVTCM01
          üîß Servicio: Artisteril Tram Service
          üìå Estado: {{ telegram_service_status }}
          ‚öôÔ∏è Acci√≥n: {{ telegram_action }}

          {% if telegram_port_connections | length > 0 %}
          üî¥ Conexiones activas en puerto 10000:
          {% for line in telegram_port_connections %}
          {{ line }}
          {% endfor %}
          {% else %}
          üü¢ No hay conexiones activas en el puerto 10000
          {% endif %}

    ############################################################
    # 3Ô∏è‚É£ Enviar mensaje a Telegram
    ############################################################
    - name: Enviar mensaje
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_id }}"
          text: "{{ telegram_message }}"
        status_code: 200
