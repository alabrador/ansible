---
- name: Enviar notificaciÃ³n Artisteril por Telegram
  hosts: localhost
  gather_facts: no

  tasks:

    - name: Normalizar variables recibidas de workflow
      set_fact:
        telegram_service_status: "{{ telegram_service_status | default('DESCONOCIDO') }}"
        telegram_action: "{{ telegram_action | default('N/A') }}"
        telegram_port_connections: "{{ telegram_port_connections | default([]) }}"
        telegram_reinicio: "{{ telegram_reinicio | default(false) }}"

    - name: Construir mensaje para ser enviado
      set_fact:
        telegram_message: |
          ðŸ–¥ï¸ Servidor: SRV-AGVTCM01
          ðŸ”§ Servicio: Artisteril Tram Service
          ðŸ“Œ Estado servicio: {{ telegram_service_status }}

          âš™ï¸ AcciÃ³n:
          {{ telegram_action }}

          {% if telegram_reinicio %}
          ðŸš¨ðŸš¨ REINICIO DEL SERVIDOR EJECUTADO ðŸš¨ðŸš¨
          Motivo: No se detectaron conexiones activas en el puerto 10000
          {% endif %}

          {% if telegram_port_connections | length > 0 %}
          ðŸŸ¢ Conexiones activas en puerto 10000:
          {% for line in telegram_port_connections %}
          {{ line }}
          {% endfor %}
          {% else %}
          ðŸ”´ No hay conexiones activas en el puerto 10000
          {% endif %}

    - name: Enviar mensaje
      uri:
        url: "https://api.telegram.org/bot{{ telegram_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_id }}"
          text: "{{ telegram_message }}"
        status_code: 200
