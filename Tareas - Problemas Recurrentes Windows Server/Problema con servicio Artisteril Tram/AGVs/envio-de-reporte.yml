---
- name: Enviar notificaciÃ³n Artisteril por Telegram
  hosts: localhost
  gather_facts: no
  connection: local

  tasks:

    - name: Normalizar variables recibidas del workflow
      set_fact:
        telegram_service_status: "{{ telegram_service_status | default('DESCONOCIDO') }}"
        telegram_action: "{{ telegram_action | default('N/A') }}"
        telegram_port_connections: "{{ telegram_port_connections | default([]) }}"

    - name: Construir mensaje Telegram
      set_fact:
        telegram_message: |
          ðŸ–¥ï¸ Servidor: SRV-AGVTCM01
          ðŸ”§ Servicio: Artisteril Tram Service
          ðŸ“Œ Estado: {{ telegram_service_status }}
          âš™ï¸ AcciÃ³n: {{ telegram_action }}

          {% if telegram_port_connections | length > 0 %}
          ðŸ”´ Conexiones activas en puerto 10000:
          {% for line in telegram_port_connections %}
          {{ line }}
          {% endfor %}
          {% else %}
          ðŸŸ¢ No hay conexiones activas en el puerto 10000
          {% endif %}

    - name: Enviar mensaje a Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: "{{ telegram_message }}"
        status_code: 200
