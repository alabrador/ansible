---
- name: Enviar reporte Citrix por Telegram
  hosts: localhost
  gather_facts: no

  vars:
    tz: "Europe/Madrid"

  tasks:

    - name: Obtener fecha y hora (EspaÃ±a - Linux estÃ¡ndar)
      set_fact:
        current_datetime: "{{ lookup('pipe', 'TZ=' ~ tz ~ ' date +\"%d-%m-%Y %H:%M:%S\"') }}"

    - name: Normalizar variables (por seguridad)
      set_fact:
        citrix_powered_on: "{{ citrix_powered_on | default([]) }}"
        citrix_restarted: "{{ citrix_restarted | default([]) }}"
        citrix_skipped: "{{ citrix_skipped | default([]) }}"

    - name: Construir bloque Encendidas
      set_fact:
        block_powered_on: |
          ðŸ”Œ MÃ¡quinas encendidas ({{ citrix_powered_on | length }}):
          {% if citrix_powered_on | length > 0 %}
          {{ citrix_powered_on | join('\n') }}
          {% else %}
          â€” Ninguna â€”
          {% endif %}

    - name: Construir bloque Reiniciadas
      set_fact:
        block_restarted: |
          ðŸ” MÃ¡quinas reiniciadas ({{ citrix_restarted | length }}):
          {% if citrix_restarted | length > 0 %}
          {{ citrix_restarted | join('\n') }}
          {% else %}
          â€” Ninguna â€”
          {% endif %}

    - name: Construir bloque Omitidas
      set_fact:
        block_skipped: |
          âš ï¸ MÃ¡quinas omitidas ({{ citrix_skipped | length }}):
          {% if citrix_skipped | length > 0 %}
          {{ citrix_skipped | join('\n') }}
          {% else %}
          â€” Ninguna â€”
          {% endif %}

    - name: Construir mensaje final
      set_fact:
        telegram_message: |
          ðŸ“Š Reporte Citrix â€“ MÃ¡quinas no registradas
          ðŸ•’ {{ current_datetime }}

          {{ block_powered_on }}

          {{ block_restarted }}

          {{ block_skipped }}

    - name: Enviar mensaje por Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: "{{ telegram_message }}"
        status_code: 200

