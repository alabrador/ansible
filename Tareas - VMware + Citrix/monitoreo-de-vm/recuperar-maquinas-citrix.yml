---
- name: Recuperar VMs Citrix NO registradas desde VMware
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    vcenter_hostname: "vcenter.alter.es"
    vcenter_validate_certs: false
    datacenter_name: "ALTER-DC"  # Ajusta segÃºn tu entorno

    # Variables heredadas desde Job1 (ya limpias)
    citrix_powered_on: "{{ citrix_powered_on | default([]) }}"
    citrix_restarted: "{{ citrix_restarted | default([]) }}"

  tasks:

    ########################################################
    # 1ï¸âƒ£ Definir rango permitido SOLO para encendido
    ########################################################
    - name: Definir rango permitido SOLO para encendido
      set_fact:
        vms_rango_encendido: >-
          {{
            citrix_powered_on
            | select('match', '^SRV-CTXP(10[1-9]|1[1-3][0-9]|14[0-5])$')
            | list
          }}

    ########################################################
    # 2ï¸âƒ£ Mostrar resumen de decisiones
    ########################################################
    - name: Mostrar resumen de decisiones
      debug:
        msg:
          - "ðŸ”Œ Se encenderÃ¡n (apagadas + en rango): {{ vms_rango_encendido }}"
          - "ðŸ” Se reiniciarÃ¡n (todas las no registradas encendidas): {{ citrix_restarted }}"

    ########################################################
    # 3ï¸âƒ£ Encendido (solo rango permitido)
    ########################################################
    - name: Encender VMs apagadas dentro del rango permitido
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: powered-on
      loop: "{{ vms_rango_encendido }}"
      when: vms_rango_encendido | length > 0

    ########################################################
    # 4ï¸âƒ£ Reinicio forzado (todas NO registradas encendidas)
    ########################################################
    - name: Reinicio forzado de TODAS las VMs NO registradas encendidas
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: restarted
      loop: "{{ citrix_restarted }}"
      when: citrix_restarted | length > 0
