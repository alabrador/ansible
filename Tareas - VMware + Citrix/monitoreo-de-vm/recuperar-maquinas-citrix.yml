---
- name: Recuperar VMs Citrix NO registradas desde VMware
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    vcenter_hostname: "vcenter.alter.es"
    vcenter_validate_certs: false
    datacenter_name: "ALTER-DC"   # Ajusta segÃºn tu entorno

    # Variables heredadas desde el playbook Citrix (set_stats)
    citrix_powered_on: "{{ citrix_powered_on | default([]) }}"
    citrix_restarted: "{{ citrix_restarted | default([]) }}"

  tasks:

    ########################################################
    # 1ï¸âƒ£ Normalizar nombres: quitar dominio Citrix
    ########################################################
    - name: Normalizar nombres de VM (quitar dominio Citrix)
      set_fact:
        citrix_powered_on_clean: >-
          {{ citrix_powered_on | map('regex_replace', '^.*\\\\', '') | list }}
        citrix_restarted_clean: >-
          {{ citrix_restarted | map('regex_replace', '^.*\\\\', '') | list }}

    ########################################################
    # 2ï¸âƒ£ Unir todas las VMs NO registradas
    ########################################################
    - name: Unir TODAS las VMs NO registradas (sin filtrar por nombre)
      set_fact:
        vms_no_registradas: "{{ citrix_powered_on_clean + citrix_restarted_clean }}"

    ########################################################
    # 3ï¸âƒ£ Definir rango permitido SOLO para encendido
    ########################################################
    - name: Definir rango permitido SOLO para encendido
      set_fact:
        vms_rango_encendido: >-
          {{
            citrix_powered_on_clean
            | select('match', '^SRV-CTXP(10[1-9]|1[1-3][0-9]|14[0-5])$')
            | list
          }}

    ########################################################
    # 4ï¸âƒ£ Mostrar resumen de decisiones
    ########################################################
    - name: Mostrar resumen de decisiones
      debug:
        msg:
          - "ðŸ”Œ Se encenderÃ¡n (apagadas + en rango): {{ vms_rango_encendido }}"
          - "ðŸ” Se reiniciarÃ¡n (todas las no registradas encendidas): {{ citrix_restarted_clean }}"

    ########################################################
    # 5ï¸âƒ£ Encendido (solo rango permitido)
    ########################################################
    - name: Encender VMs apagadas dentro del rango permitido
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: powered-on
      loop: "{{ vms_rango_encendido }}"
      when: vms_rango_encendido | length > 0

    ########################################################
    # 6ï¸âƒ£ Reinicio forzado (todas NO registradas)
    ########################################################
    - name: Reinicio forzado de TODAS las VMs NO registradas encendidas
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: restarted
      loop: "{{ citrix_restarted_clean }}"
      when: citrix_restarted_clean | length > 0
