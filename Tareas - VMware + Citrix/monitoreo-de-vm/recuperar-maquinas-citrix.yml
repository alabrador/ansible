---
- name: Recuperar VMs Citrix NO registradas desde VMware
  hosts: localhost
  gather_facts: no

  vars:
    vcenter_hostname: "vcenter.alter.es"
    vcenter_validate_certs: false
    datacenter_name: "ALTER-DC"   # ajusta si aplica

    # Variables heredadas desde el playbook Citrix (set_stats)
    citrix_powered_on: "{{ citrix_powered_on | default([]) }}"
    citrix_restarted: "{{ citrix_restarted | default([]) }}"

  tasks:

    - name: Unir TODAS las VMs NO registradas (sin filtrar por nombre)
      set_fact:
        vms_no_registradas: "{{ citrix_powered_on + citrix_restarted }}"

    - name: Definir rango permitido SOLO para encendido
      set_fact:
        vms_rango_encendido: >-
          {{
            vms_no_registradas
            | select('match', '^SRV-CTXP(10[1-9]|1[1-3][0-9]|14[0-5])$')
            | list
          }}

    - name: Mostrar resumen de decisiones
      debug:
        msg:
          - "ðŸ”Œ Se encenderÃ¡n (apagadas + en rango): {{ citrix_powered_on | intersect(vms_rango_encendido) }}"
          - "ðŸ” Se reiniciarÃ¡n (todas las no registradas encendidas): {{ citrix_restarted }}"

    #################################################################
    # ENCENDIDO
    # Solo VMs apagadas + dentro del rango SRV-CTXP101-145
    #################################################################

    - name: Encender VMs apagadas dentro del rango permitido
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: powered-on
      loop: "{{ citrix_powered_on | intersect(vms_rango_encendido) }}"
      when: citrix_powered_on | length > 0

    #################################################################
    # REINICIO
    # TODAS las VMs encendidas NO registradas, sin importar el nombre
    #################################################################

    - name: Reinicio forzado de TODAS las VMs NO registradas encendidas
      community.vmware.vmware_guest_powerstate:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ vcenter_validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        name: "{{ item }}"
        state: restarted
      loop: "{{ citrix_restarted }}"
      when: citrix_restarted | length > 0
