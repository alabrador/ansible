---
- name: Gestionar VMs Citrix Unregistered (Power ON / Restart)
  hosts: SRV-DDC01
  gather_facts: no
  become: false

  tasks:

    - name: Obtener mÃ¡quinas Citrix no registradas
      win_shell: |
        Add-PSSnapin Citrix.Broker.Admin.V2 -ErrorAction SilentlyContinue

        $machines = Get-BrokerMachine -RegistrationState Unregistered |
          Select-Object MachineName, PowerState

        $result = @{
          powered_on = @()
          restarted  = @()
          skipped    = @()
        }

        foreach ($m in $machines) {
          if ($m.PowerState -eq "Off") {
            Start-BrokerMachine -MachineName $m.MachineName
            $result.powered_on += $m.MachineName
          }
          elseif ($m.PowerState -eq "On") {
            Restart-BrokerMachine -MachineName $m.MachineName -Force
            $result.restarted += $m.MachineName
          }
          else {
            $result.skipped += "$($m.MachineName) ($($m.PowerState))"
          }
        }

        $result | ConvertTo-Json -Depth 3
      register: citrix_actions

    - name: Convertir resultado a variable Ansible
      set_fact:
        citrix_result: "{{ citrix_actions.stdout | from_json }}"

    - name: Limpiar nombres de dominio de las VMs
      set_fact:
        citrix_powered_on: >-
          {{ citrix_result.powered_on | map('regex_replace', '^.*\\\\', '') | list }}
        citrix_restarted: >-
          {{ citrix_result.restarted | map('regex_replace', '^.*\\\\', '') | list }}
        citrix_skipped: >-
          {{ citrix_result.skipped | map('regex_replace', '^.*\\\\', '') | list }}

    - name: Mostrar resumen
      debug:
        msg:
          - "ğŸŸ¢ Encendidas: {{ citrix_powered_on | length }}"
          - "ğŸ” Reiniciadas: {{ citrix_restarted | length }}"
          - "âš ï¸ Omitidas: {{ citrix_skipped | length }}"

    - name: Exportar resultado para AWX Workflow
      set_stats:
        data:
          citrix_powered_on: "{{ citrix_powered_on }}"
          citrix_restarted: "{{ citrix_restarted }}"
          citrix_skipped: "{{ citrix_skipped }}"
