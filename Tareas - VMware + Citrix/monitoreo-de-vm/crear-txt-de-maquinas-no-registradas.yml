---
# PLAY 1 â€“ Windows (solo Windows)
- name: Generar archivo en Windows
  hosts: srv-ddc01
  gather_facts: no

  vars:
    windows_tmp_file: "C:\\Temp\\unregistered_machines.txt"

  tasks:
    - name: Obtener mÃ¡quinas sin registrar
      win_shell: |
        Add-PSSnapin Citrix.Broker.Admin.V2 -ErrorAction SilentlyContinue
        $unregistered = Get-BrokerMachine -RegistrationState Unregistered -ErrorAction SilentlyContinue

        if ($unregistered) {
          $lines = @()
          foreach ($m in $unregistered) {
            $lines += "ðŸ–¥ Name: $($m.MachineName) | State: $($m.RegistrationState) | Power: $($m.PowerState)"
          }
          $lines -join "`n"
        } else {
          "ALL_REGISTERED"
        }
      register: unregistered_machines
      changed_when: false

    - name: Guardar archivo en Windows
      win_copy:
        content: "{{ unregistered_machines.stdout }}"
        dest: "{{ windows_tmp_file }}"

    - name: Guardar contenido como fact global
      set_fact:
        report_content: "{{ unregistered_machines.stdout }}"

# PLAY 2 â€“ Controller AWX (Linux puro)
- name: Guardar archivo en el controller AWX
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    controller_dest: "/tmp/unregistered_machines.txt"

  tasks:
    - name: Crear archivo en el controller
      copy:
        content: "{{ hostvars['srv-ddc01'].report_content }}"
        dest: "{{ controller_dest }}"
