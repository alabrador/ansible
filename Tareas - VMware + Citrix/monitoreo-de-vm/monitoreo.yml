---
############################################################
# PLAY 1 - Obtener VMs Citrix reiniciadas desde vCenter
############################################################
- name: Detectar VMs Citrix reiniciadas en vCenter
  hosts: localhost
  gather_facts: no

  vars:
    vcenter_hostname: "vcenter.alter.es"
    vcenter_user: "{{ vcenter_user }}"
    vcenter_password: "{{ vcenter_password }}"
    validate_certs: no

    datacenter_name: "MATEO INURRIA"
    cluster_name: "CL_CITRIX"

    last_boot_minutes: 10

  tasks:

    - name: Obtener todas las VMs del cluster CL_CITRIX
      community.vmware.vmware_vm_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        cluster: "{{ cluster_name }}"
      register: vms_info

    - name: Filtrar VMs encendidas reiniciadas recientemente
      set_fact:
        restarted_vms: >-
          {{
            vms_info.virtual_machines
            | selectattr('runtime.powerState', 'equalto', 'poweredOn')
            | selectattr('runtime.bootTime', 'defined')
            | selectattr(
                'runtime.bootTime',
                '>=',
                (ansible_date_time.iso8601
                 | to_datetime('%Y-%m-%dT%H:%M:%SZ')
                 - timedelta(minutes=last_boot_minutes))
              )
            | list
          }}

    - name: Mostrar VMs reiniciadas
      debug:
        msg: "VM {{ item.name }} reiniciada en {{ item.runtime.bootTime }}"
      loop: "{{ restarted_vms }}"
      loop_control:
        label: "{{ item.name }}"

############################################################
# PLAY 2 - Validar registro de VMs en Citrix Director
############################################################
- name: Verificar registro de VMs en Citrix Director
  hosts: citrix_controllers
  gather_facts: no
  become: false

  vars:
    telegram_bot_token: "{{ telegram_bot_token }}"
    telegram_chat_id: "{{ telegram_chat_id }}"

  tasks:

    - name: Comprobar estado de VMs en Citrix Director
      win_shell: |
        Add-PSSnapin Citrix.*
        $result = @()

        {% for vm in hostvars['localhost'].restarted_vms %}
        $m = Get-BrokerMachine -MachineName "{{ vm.name }}" -ErrorAction SilentlyContinue
        if ($m) {
          $result += [PSCustomObject]@{
            Name              = $m.Name
            RegistrationState = $m.RegistrationState
            MachineCatalog    = $m.MachineCatalog
            DeliveryGroup     = $m.DesktopGroupName
          }
        }
        {% endfor %}

        $result | ConvertTo-Json
      register: citrix_status

    - name: Construir mensaje de alerta para Telegram
      set_fact:
        telegram_message: |
          ‚ö†Ô∏è ALERTA CITRIX ‚Äì VMs no registradas ‚ö†Ô∏è

          {% set vms = citrix_status.stdout | from_json %}
          {% for vm in vms %}
          {% if vm.RegistrationState != 'Registered' %}
          üñ•Ô∏è VM: {{ vm.Name }}
          üì¶ Cat√°logo: {{ vm.MachineCatalog }}
          üë• Delivery Group: {{ vm.DeliveryGroup }}
          ‚ùå Estado: {{ vm.RegistrationState }}
          ----------------------------
          {% endif %}
          {% endfor %}
      when: citrix_status.stdout is defined and citrix_status.stdout != ""

    - name: Enviar alerta por Telegram si hay VMs no registradas
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: "{{ telegram_message }}"
        status_code: 200
      when:
        - telegram_message is defined
        - "'VM:' in telegram_message"
