---
- name: Monitorizar VMs Citrix del cluster CL_CITRIX y validar registro en Director
  hosts: localhost
  gather_facts: no

  vars:
    # vCenter
    vcenter_hostname: "vcenter.alter.es"
    vcenter_user: "{{ vcenter_user }}"
    vcenter_password: "{{ vcenter_password }}"
    validate_certs: no

    datacenter_name: "MATEO INURRIA"
    cluster_name: "CL_CITRIX"

    # Citrix
    citrix_controller: "{{ citrix_controller }}"
    citrix_user: "{{ citrix_user }}"
    citrix_password: "{{ citrix_password }}"

    # Telegram
    telegram_bot_token: "{{ telegram_bot_token }}"
    telegram_chat_id: "{{ telegram_chat_id }}"

    # Ventana de reinicio
    last_boot_minutes: 10

  tasks:

    - name: Obtener VMs del cluster CL_CITRIX
      community.vmware.vmware_vm_info:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        validate_certs: "{{ validate_certs }}"
        datacenter: "{{ datacenter_name }}"
        cluster: "{{ cluster_name }}"
      register: vms_info

    - name: Filtrar VMs encendidas reiniciadas recientemente
      set_fact:
        restarted_vms: >-
          {{
            vms_info.virtual_machines
            | selectattr('runtime.powerState', 'equalto', 'poweredOn')
            | selectattr('runtime.bootTime', 'defined')
            | selectattr(
                'runtime.bootTime',
                '>=',
                (ansible_date_time.iso8601
                 | to_datetime('%Y-%m-%dT%H:%M:%SZ')
                 - timedelta(minutes=last_boot_minutes))
              )
            | list
          }}

    - name: Mostrar VMs reiniciadas
      debug:
        msg: >
          VM {{ item.name }} reiniciada en {{ item.runtime.bootTime }}
      loop: "{{ restarted_vms }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Verificar estado en Citrix Director
      win_shell: |
        Add-PSSnapin Citrix.*
        $vm = Get-BrokerMachine -MachineName "{{ item.name }}" -ErrorAction SilentlyContinue
        if ($vm) {
          $vm | Select Name, MachineCatalog, DesktopGroupName, RegistrationState | ConvertTo-Json
        }
      loop: "{{ restarted_vms }}"
      loop_control:
        label: "{{ item.name }}"
      register: citrix_status
      delegate_to: "{{ citrix_controller }}"

    - name: Construir mensaje de alerta
      set_fact:
        telegram_message: |
          âš ï¸ *ALERTA CITRIX â€“ VMs no registradas* âš ï¸

          {% for r in citrix_status.results %}
          {% if r.stdout is defined and r.stdout != "" %}
          {% set vm = r.stdout | from_json %}
          {% if vm.RegistrationState != 'Registered' %}
          ðŸ–¥ï¸ VM: {{ vm.Name }}
          ðŸ“¦ CatÃ¡logo: {{ vm.MachineCatalog }}
          ðŸ‘¥ Delivery Group: {{ vm.DesktopGroupName }}
          âŒ Estado: {{ vm.RegistrationState }}
          -------------------------
          {% endif %}
          {% endif %}
          {% endfor %}
      when: citrix_status.results | length > 0

    - name: Enviar alerta por Telegram
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: "{{ telegram_message }}"
          parse_mode: "Markdown"
        status_code: 200
      when:
        - telegram_message is defined
        - "'VM:' in telegram_message"
