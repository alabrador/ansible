---
- name: Mantenimiento WordPress ProducciÃ³n
  hosts: srv-cpweb02
  become: yes
  gather_facts: yes

  vars:
    wp_base_path: /home
    wp_bin: /usr/local/bin/wp

    wp_sites:
      - domain: algry.com
        user: algry9302
      - domain: bodegasduron.com
        user: bodeg3787
      - domain: nutribenprofesionales.es
        user: nutri8393
      - domain: nutribeninternational.com
        user: nutri7976

  pre_tasks:

    - name: Avisar inicio mantenimiento
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: form-urlencoded
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            ğŸš§ *Inicio mantenimiento WordPress*
            ğŸ–¥ Servidor: {{ inventory_hostname }}
            ğŸŒ Sitios: {{ wp_sites | map(attribute='domain') | join(', ') }}
            ğŸ•’ {{ ansible_date_time.iso8601 }}
      delegate_to: localhost

  tasks:

    - name: Mantenimiento WordPress
      block:

        - name: Activar mantenimiento
          shell: >
            sudo -H -u {{ item.user }} {{ wp_bin }} maintenance-mode activate
          args:
            chdir: "{{ wp_base_path }}/{{ item.domain }}/public_html"
          loop: "{{ wp_sites }}"
          failed_when: false

        - name: Actualizar core
          shell: >
            sudo -H -u {{ item.user }} {{ wp_bin }} core update
          args:
            chdir: "{{ wp_base_path }}/{{ item.domain }}/public_html"
          loop: "{{ wp_sites }}"
          register: core_update
          failed_when: false

        - name: Actualizar plugins
          shell: >
            sudo -H -u {{ item.user }} {{ wp_bin }} plugin update --all
            --exclude=advanced-custom-fields-pro,js_composer
          args:
            chdir: "{{ wp_base_path }}/{{ item.domain }}/public_html"
          loop: "{{ wp_sites }}"
          register: plugin_update
          failed_when: false

        - name: Actualizar themes
          shell: >
            sudo -H -u {{ item.user }} {{ wp_bin }} theme update --all
          args:
            chdir: "{{ wp_base_path }}/{{ item.domain }}/public_html"
          loop: "{{ wp_sites }}"
          register: theme_update
          failed_when: false

        - name: Notificar errores detectados
          uri:
            url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
            method: POST
            body_format: form-urlencoded
            body:
              chat_id: "{{ telegram_chat_id }}"
              text: |
                ğŸš¨ *Error en mantenimiento WordPress*
                ğŸŒ Sitio: {{ item.item.domain }}
                ğŸ“¦ Tarea: {{ item.invocation.module_name }}
                âŒ CÃ³digo retorno: {{ item.rc }}
          loop: >
            {{
              (core_update.results + plugin_update.results + theme_update.results)
              | selectattr('rc', 'ne', 0)
              | list
            }}
          when: >
            (
              (core_update.results + plugin_update.results + theme_update.results)
              | selectattr('rc', 'ne', 0)
              | list
              | length
            ) > 0
          delegate_to: localhost

      always:

        - name: Desactivar mantenimiento (SIEMPRE)
          shell: >
            sudo -H -u {{ item.user }} {{ wp_bin }} maintenance-mode deactivate
          args:
            chdir: "{{ wp_base_path }}/{{ item.domain }}/public_html"
          loop: "{{ wp_sites }}"
          failed_when: false

  post_tasks:

    - name: Resumen final mantenimiento
      uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: form-urlencoded
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: |
            âœ… *Mantenimiento WordPress finalizado*
            ğŸ–¥ Servidor: {{ inventory_hostname }}
            ğŸŒ Sitios totales: {{ wp_sites | length }}
            ğŸ”„ Core OK: {{ core_update.results | selectattr('rc','eq',0) | list | length }}
            ğŸ”Œ Plugins OK: {{ plugin_update.results | selectattr('rc','eq',0) | list | length }}
            ğŸ¨ Themes OK: {{ theme_update.results | selectattr('rc','eq',0) | list | length }}
            ğŸ•’ {{ ansible_date_time.iso8601 }}
      delegate_to: localhost


